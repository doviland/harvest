<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harvest Time Analyzer - Versione Minimal</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            color: #4a5568;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #718096;
            font-size: 1.1rem;
        }
        
        .upload-section {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .drop-zone {
            border: 3px dashed #cbd5e0;
            border-radius: 15px;
            padding: 60px 20px;
            background: #f7fafc;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .drop-zone:hover, .drop-zone.dragover {
            border-color: #4299e1;
            background: #ebf8ff;
            transform: translateY(-2px);
        }
        
        .drop-icon {
            font-size: 4rem;
            color: #a0aec0;
            margin-bottom: 20px;
        }
        
        .drop-text {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 10px;
        }
        
        .drop-subtext {
            color: #718096;
            margin-bottom: 20px;
        }
        
        .file-info {
            background: #edf2f7;
            padding: 10px 20px;
            border-radius: 25px;
            color: #4a5568;
            font-size: 0.9rem;
        }
        
        .results {
            display: none;
        }
        
        .cost-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .cost-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .cost-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
        }
        
        .cost-card.digital::before { background: linear-gradient(90deg, #f56565, #e53e3e); }
        .cost-card.operativi::before { background: linear-gradient(90deg, #ed8936, #dd6b20); }
        .cost-card.generali::before { background: linear-gradient(90deg, #718096, #4a5568); }
        .cost-card.fatturabili::before { background: linear-gradient(90deg, #48bb78, #38a169); }
        
        .cost-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #4a5568;
        }
        
        .cost-hours {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .cost-card.digital .cost-hours { color: #e53e3e; }
        .cost-card.operativi .cost-hours { color: #dd6b20; }
        .cost-card.generali .cost-hours { color: #4a5568; }
        .cost-card.fatturabili .cost-hours { color: #38a169; }
        
        .cost-percentage {
            font-size: 1.1rem;
            font-weight: 600;
            color: #718096;
        }
        
        .stats-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .stats-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }
        
        .stat-item {
            text-align: center;
            padding: 20px;
            background: #f7fafc;
            border-radius: 10px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4299e1;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #718096;
            font-weight: 600;
        }
        
        .table-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        th {
            background: #f7fafc;
            font-weight: bold;
            color: #4a5568;
        }
        
        tr:hover {
            background: #f7fafc;
        }
        
        .category-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .badge-digital { background: #fed7d7; color: #c53030; }
        .badge-operativi { background: #feebc8; color: #c05621; }
        .badge-generali { background: #edf2f7; color: #4a5568; }
        .badge-fatturabili { background: #c6f6d5; color: #2f855a; }
        
        .loading {
            display: none;
            text-align: center;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #4299e1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .alert.success {
            background: #c6f6d5;
            color: #2f855a;
            border: 2px solid #9ae6b4;
        }
        
        .alert.error {
            background: #fed7d7;
            color: #c53030;
            border: 2px solid #fbb6ce;
        }
        
        .close-btn {
            float: right;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: inherit;
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header h1 { font-size: 2rem; }
            .cost-hours { font-size: 2.5rem; }
            th, td { padding: 10px; font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        
        <!-- Header -->
        <div class="header">
            <h1>üïê Harvest Time Analyzer</h1>
            <p>Analisi automatica per tipologie di costo</p>
        </div>

        <!-- Upload Section -->
        <div class="upload-section">
            <h2 style="color: #4a5568; margin-bottom: 30px; font-size: 1.8rem;">üìä Carica File Excel di Harvest</h2>
            
            <div class="drop-zone" id="dropZone">
                <div class="drop-icon">üìÅ</div>
                <div class="drop-text">Trascina qui il file Excel</div>
                <div class="drop-subtext">oppure clicca per selezionarlo</div>
                <div class="file-info">Formati supportati: .xlsx, .xls ‚Ä¢ Dimensione max: 10MB</div>
            </div>
            
            <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="color: #4a5568; font-size: 1.2rem;">Elaborazione file in corso...</p>
        </div>

        <!-- Results -->
        <div class="results" id="results">
            
            <!-- Cost Types Cards -->
            <div class="cost-grid">
                <div class="cost-card digital">
                    <div class="cost-title">üî¥ Costi Digital</div>
                    <div class="cost-hours" id="costiDigitalOre">0h</div>
                    <div class="cost-percentage" id="costiDigitalPerc">0%</div>
                </div>
                
                <div class="cost-card operativi">
                    <div class="cost-title">üü† Costi Operativi</div>
                    <div class="cost-hours" id="costiOperativiOre">0h</div>
                    <div class="cost-percentage" id="costiOperativiPerc">0%</div>
                </div>
                
                <div class="cost-card generali">
                    <div class="cost-title">‚ö´ Costi Generali</div>
                    <div class="cost-hours" id="costiGeneraliOre">0h</div>
                    <div class="cost-percentage" id="costiGeneraliPerc">0%</div>
                </div>
                
                <div class="cost-card fatturabili">
                    <div class="cost-title">üü¢ Clienti Fatturabili</div>
                    <div class="cost-hours" id="clientiFatturabiliOre">0h</div>
                    <div class="cost-percentage" id="clientiFatturabiliPerc">0%</div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="stats-section">
                <div class="stats-title">üìà Statistiche Generali</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalHours">0h</div>
                        <div class="stat-label">Ore Totali</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalClients">0</div>
                        <div class="stat-label">Clienti</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalActivities">0</div>
                        <div class="stat-label">Attivit√†</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="dailyAverage">0h</div>
                        <div class="stat-label">Media/Giorno</div>
                    </div>
                </div>
            </div>

            <!-- Detailed Table -->
            <div class="table-section">
                <div class="stats-title">üìã Dettaglio Clienti per Categoria</div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Categoria</th>
                                <th>Ore</th>
                                <th>Percentuale</th>
                                <th>Attivit√†</th>
                            </tr>
                        </thead>
                        <tbody id="clientTableBody">
                            <tr>
                                <td colspan="5" style="text-align: center; color: #718096; padding: 40px;">
                                    Carica un file Excel per visualizzare i dati
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <!-- XLSX Library incorporata -->
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- Fallback per XLSX se il CDN non funziona -->
    <script>
        if (typeof XLSX === 'undefined') {
            // Crea un mock temporaneo per evitare errori
            window.XLSX = {
                read: function() { 
                    throw new Error('Libreria XLSX non disponibile. Prova a ricaricare la pagina.'); 
                }
            };
        }
    </script>

    <!-- Applicazione JavaScript -->
    <script>
        class HarvestAnalyzer {
            constructor() {
                this.data = [];
                this.stats = {
                    totalHours: 0,
                    clients: new Map(),
                    costTypes: {
                        'Costi Digital': { hours: 0, entries: 0 },
                        'Costi Operativi': { hours: 0, entries: 0 },
                        'Costi Generali': { hours: 0, entries: 0 },
                        'Clienti Fatturabili': { hours: 0, entries: 0 }
                    }
                };
                
                this.init();
            }

            init() {
                const dropZone = document.getElementById('dropZone');
                const fileInput = document.getElementById('fileInput');

                dropZone.addEventListener('click', () => fileInput.click());
                
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('dragover');
                });
                
                dropZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                });
                
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                    if (e.dataTransfer.files.length > 0) {
                        this.processFile(e.dataTransfer.files[0]);
                    }
                });
                
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.processFile(e.target.files[0]);
                    }
                });
            }

            processFile(file) {
                if (!this.validateFile(file)) return;
                
                this.showLoading(true);
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        if (typeof XLSX === 'undefined' || typeof XLSX.read !== 'function') {
                            throw new Error('Libreria Excel non disponibile. Ricarica la pagina.');
                        }

                        const workbook = XLSX.read(e.target.result, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                        this.processData(jsonData);
                        
                    } catch (error) {
                        this.showAlert('Errore elaborazione: ' + error.message, 'error');
                        this.showLoading(false);
                    }
                };
                
                reader.readAsArrayBuffer(file);
            }

            validateFile(file) {
                if (file.size > 10 * 1024 * 1024) {
                    this.showAlert('File troppo grande (max 10MB)', 'error');
                    return false;
                }
                
                if (!file.name.match(/\.(xlsx|xls)$/i)) {
                    this.showAlert('Formato non supportato. Usa file .xlsx o .xls', 'error');
                    return false;
                }
                
                return true;
            }

            processData(rawData) {
                if (!rawData || rawData.length === 0) {
                    this.showAlert('File Excel vuoto', 'error');
                    this.showLoading(false);
                    return;
                }

                // Reset stats
                this.data = [];
                this.stats.totalHours = 0;
                this.stats.clients.clear();
                Object.keys(this.stats.costTypes).forEach(key => {
                    this.stats.costTypes[key] = { hours: 0, entries: 0 };
                });

                // Find header row
                let headerIndex = 0;
                for (let i = 0; i < Math.min(5, rawData.length); i++) {
                    if (rawData[i] && rawData[i].some(cell => 
                        cell && cell.toString().toLowerCase().includes('note')
                    )) {
                        headerIndex = i;
                        break;
                    }
                }

                // Process rows
                for (let i = headerIndex + 1; i < rawData.length; i++) {
                    const row = rawData[i];
                    if (!row || row.length === 0) continue;
                    
                    const notes = row[0] || '';
                    const hours = this.parseHours(row[1]);
                    
                    if (!notes && hours <= 0) continue;

                    const { client, activity } = this.parseNotes(notes);
                    const costType = this.categorize(client, activity);

                    const entry = {
                        client,
                        activity,
                        hours,
                        costType,
                        originalNotes: notes
                    };

                    this.data.push(entry);
                    this.updateStats(entry);
                }

                if (this.data.length === 0) {
                    this.showAlert('Nessun dato valido trovato', 'error');
                    this.showLoading(false);
                    return;
                }

                this.displayResults();
            }

            parseHours(value) {
                if (!value) return 0;
                if (typeof value === 'number') return value;
                
                const parsed = parseFloat(value.toString().replace(',', '.'));
                return isNaN(parsed) ? 0 : Math.max(0, parsed);
            }

            parseNotes(notes) {
                if (!notes) return { client: 'NON SPECIFICATO', activity: 'Attivit√† generica' };
                
                const notesStr = notes.toString().trim();
                const colonIndex = notesStr.indexOf(':');
                
                if (colonIndex > 0) {
                    return {
                        client: notesStr.substring(0, colonIndex).trim().toUpperCase(),
                        activity: notesStr.substring(colonIndex + 1).trim()
                    };
                } else {
                    return {
                        client: notesStr.toUpperCase(),
                        activity: 'Attivit√† generica'
                    };
                }
            }

            categorize(client, activity) {
                const clientUpper = client.toUpperCase();
                const activityUpper = activity.toUpperCase();
                const full = `${clientUpper}: ${activityUpper}`;

                // Costi Operativi (primo per evitare conflitti)
                const operativi = [
                    'GESTIONE HARVEST', 'HARVEST',
                    'RIUNIONE DIGITAL', 'RIUNIONE BLOG', 'RIUNIONE VIDEO',
                    'ASANA DIGITAL', 'ASANA BLOG',
                    'COMUNICAZIONE CON TEAM', 'COMUNICAZIONE CON NICO', 'COMUNICAZIONE CON FABIO',
                    'COMUNICAZIONE CON FILIPPO', 'COMUNICAZIONE CON COMMERCIALI', 
                    'COMUNICAZIONE CON CRISTINA', 'COMUNICAZIONE'
                ];
                
                for (let item of operativi) {
                    if (clientUpper === item || full.includes(item)) {
                        return 'Costi Operativi';
                    }
                }

                // Costi Digital
                const digital = [
                    'GESTIONE CLIENTI', 'CONTROLLO MATTUTINI', 'GESTIONE DIGITAL',
                    'GESTIONE ATTIVITA', 'GESTIONE ATTIVIT√Ä', 'GESTIONE SPONSORIZZATE', 
                    'GESTIONE VIDEO', 'GESTIONE BLOG'
                ];
                
                for (let item of digital) {
                    if (clientUpper === item || full.includes(item)) {
                        return 'Costi Digital';
                    }
                }

                // Costi Generali
                const generali = ['FORMAZIONE', 'COLLOQUI', 'AMMINISTRAZIONE', 'PAUSA'];
                
                for (let item of generali) {
                    if (clientUpper === item || full.includes(item) || activityUpper.includes(item) ||
                        (item === 'PAUSA' && clientUpper.toLowerCase() === 'pausa')) {
                        return 'Costi Generali';
                    }
                }

                // NON SPECIFICATO
                if (['NON SPECIFICATO', '', 'UNDEFINED'].includes(clientUpper)) {
                    return 'Costi Generali';
                }

                return 'Clienti Fatturabili';
            }

            updateStats(entry) {
                this.stats.totalHours += entry.hours;
                
                // Cost type stats
                this.stats.costTypes[entry.costType].hours += entry.hours;
                this.stats.costTypes[entry.costType].entries += 1;
                
                // Client stats
                if (!this.stats.clients.has(entry.client)) {
                    this.stats.clients.set(entry.client, {
                        name: entry.client,
                        hours: 0,
                        entries: 0,
                        activities: new Set(),
                        costType: entry.costType
                    });
                }
                
                const clientStat = this.stats.clients.get(entry.client);
                clientStat.hours += entry.hours;
                clientStat.entries += 1;
                clientStat.activities.add(entry.activity);
            }

            displayResults() {
                this.showLoading(false);
                document.getElementById('results').style.display = 'block';
                
                // Update cost type cards
                Object.keys(this.stats.costTypes).forEach(type => {
                    const data = this.stats.costTypes[type];
                    const percentage = this.stats.totalHours > 0 ? (data.hours / this.stats.totalHours * 100) : 0;
                    
                    const elementMap = {
                        'Costi Digital': 'costiDigitalOre',
                        'Costi Operativi': 'costiOperativiOre',
                        'Costi Generali': 'costiGeneraliOre',
                        'Clienti Fatturabili': 'clientiFatturabiliOre'
                    };
                    
                    const percMap = {
                        'Costi Digital': 'costiDigitalPerc',
                        'Costi Operativi': 'costiOperativiPerc',
                        'Costi Generali': 'costiGeneraliPerc',
                        'Clienti Fatturabili': 'clientiFatturabiliPerc'
                    };
                    
                    document.getElementById(elementMap[type]).textContent = data.hours.toFixed(1) + 'h';
                    document.getElementById(percMap[type]).textContent = percentage.toFixed(1) + '%';
                });

                // Update general stats
                document.getElementById('totalHours').textContent = this.stats.totalHours.toFixed(1) + 'h';
                document.getElementById('totalClients').textContent = this.stats.clients.size;
                document.getElementById('totalActivities').textContent = this.data.length;
                document.getElementById('dailyAverage').textContent = (this.stats.totalHours / 30).toFixed(1) + 'h';

                // Update table
                this.updateTable();
                
                this.showAlert(`‚úÖ File elaborato! ${this.data.length} attivit√† per ${this.stats.totalHours.toFixed(2)} ore totali.`, 'success');
            }

            updateTable() {
                const tbody = document.getElementById('clientTableBody');
                tbody.innerHTML = '';

                const sortedClients = Array.from(this.stats.clients.values())
                    .sort((a, b) => b.hours - a.hours);

                sortedClients.forEach(client => {
                    const percentage = (client.hours / this.stats.totalHours * 100).toFixed(1);
                    
                    const badgeClass = {
                        'Costi Digital': 'badge-digital',
                        'Costi Operativi': 'badge-operativi',
                        'Costi Generali': 'badge-generali',
                        'Clienti Fatturabili': 'badge-fatturabili'
                    }[client.costType];

                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td><strong>${client.name}</strong></td>
                        <td><span class="category-badge ${badgeClass}">${client.costType}</span></td>
                        <td><strong>${client.hours.toFixed(2)}h</strong></td>
                        <td><strong>${percentage}%</strong></td>
                        <td>${client.activities.size}</td>
                    `;
                });
            }

            showLoading(show) {
                document.getElementById('loading').style.display = show ? 'block' : 'none';
            }

            showAlert(message, type = 'success') {
                const existing = document.querySelector('.alert');
                if (existing) existing.remove();

                const alert = document.createElement('div');
                alert.className = `alert ${type}`;
                alert.innerHTML = `
                    ${message}
                    <button class="close-btn" onclick="this.parentElement.remove()">√ó</button>
                `;

                document.querySelector('.container').insertBefore(alert, document.querySelector('.upload-section'));
                
                setTimeout(() => {
                    if (document.body.contains(alert)) alert.remove();
                }, type === 'error' ? 8000 : 5000);
            }
        }

        // Inizializza quando la pagina √® pronta
        document.addEventListener('DOMContentLoaded', function() {
            // Attendi che XLSX sia disponibile
            let attempts = 0;
            const maxAttempts = 20;
            
            function initApp() {
                if (typeof XLSX !== 'undefined' && typeof XLSX.read === 'function') {
                    window.harvestAnalyzer = new HarvestAnalyzer();
                    console.log('‚úÖ Harvest Analyzer inizializzato');
                } else if (attempts < maxAttempts) {
                    attempts++;
                    setTimeout(initApp, 250);
                } else {
                    // Crea versione fallback
                    console.warn('‚ö†Ô∏è XLSX non disponibile, modalit√† fallback');
                    window.harvestAnalyzer = new HarvestAnalyzer();
                }
            }
            
            initApp();
        });
    </script>
</body>
</html>